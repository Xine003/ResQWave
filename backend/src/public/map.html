<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Map Alerts (Realtime)</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body { font-family: Arial, sans-serif; margin: 16px; }
      h2 { margin-bottom: 4px; }
      #status { margin-left: 8px; color: #555; }
      table { border-collapse: collapse; width: 100%; margin-top: 12px; margin-bottom: 32px; }
      th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
      th { background: #f5f5f5; text-align: left; }
    </style>
  </head>
  <body>
    <h2>Map Alerts (Realtime)</h2>
    <div class="row">
      <label>JWT Token:</label>
      <input id="token" type="text" size="80" placeholder="Paste Admin/Dispatcher JWT here" />
      <button id="connectBtn">Connect</button>
      <span id="status"></span>
    </div>

    <h3>Unassigned Alerts</h3>
    <table>
      <thead>
        <tr>
          <th>Community Group</th>
          <th>Alert Type</th>
          <th>Time Sent</th>
          <th>Address</th>
        </tr>
      </thead>
      <tbody id="unassigned"></tbody>
    </table>

    <h3>Waitlist</h3>
    <table>
      <thead>
        <tr>
          <th>Community Group</th>
          <th>Alert Type</th>
          <th>Time Sent</th>
          <th>Address</th>
        </tr>
      </thead>
      <tbody id="waitlist"></tbody>
    </table>

    <script>
    const tokenEl = document.getElementById("token");
    const connectBtn = document.getElementById("connectBtn");
    const statusEl = document.getElementById("status");

    const unassignedEl = document.getElementById("unassigned");
    const waitlistEl = document.getElementById("waitlist");

    let socket;

    function addRow(tableEl, a) {
      const tr = document.createElement("tr");
      tr.setAttribute("data-alert-id", a.alertID || a.id); // ✅ match backend casing
      tr.innerHTML = `
        <td>${a.communityGroupName || ""}</td>
        <td>${a.alertType || ""}</td>
        <td>${a.timeSent ? new Date(a.timeSent).toLocaleString() : ""}</td>
        <td>${a.address || ""}</td>
      `;
      tableEl.insertBefore(tr, tableEl.firstChild);
    }

    function removeRow(alertID) {
      const row = document.querySelector(`tr[data-alert-id="${alertID}"]`);
      if (row) row.remove();
    }

    connectBtn.onclick = () => {
      const token = tokenEl.value.trim();
      if (!token) {
        alert("Please paste a JWT token first.");
        return;
      }
      if (socket) socket.disconnect();

      socket = io("/", { auth: { token } });

      socket.on("connect", () => {
        statusEl.textContent = "Connected";
        statusEl.style.color = "green";

        // Initial load
        Promise.all([
          fetch("/alerts/map/unassigned", { headers: { Authorization: `Bearer ${token}` } }).then(r => r.json()),
          fetch("/alerts/map/waitlisted", { headers: { Authorization: `Bearer ${token}` } }).then(r => r.json())
        ]).then(([unassigned, waitlist]) => {
          unassignedEl.innerHTML = "";
          waitlistEl.innerHTML = "";
          unassigned.forEach(a => addRow(unassignedEl, a));
          waitlist.forEach(a => addRow(waitlistEl, a));
        });
      });

      socket.on("connect_error", (e) => {
        statusEl.textContent = "Connect error: " + e.message;
        statusEl.style.color = "red";
      });

      // New alerts
      socket.on("liveReport:new", (a) => {
        const mapped = {
          alertID: a.alertID,
          communityGroupName: a.communityGroupName || "",
          alertType: a.alertType,
          timeSent: a.lastSignalTime,
          address: a.address,
          status: a.status
        };

        if (mapped.status === "Unassigned") {
          addRow(unassignedEl, mapped);
        } else if (mapped.status === "Waitlist") {
          addRow(waitlistEl, mapped);
        }
      });

      // Status updates
      socket.on("alertStatusUpdated", async (data) => {
        console.log("Status update received:", data);

        // ✅ Remove old row
        removeRow(data.alertID);

        try {
          // ✅ Fetch full alert info
          const res = await fetch(`/alerts/${data.alertID}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          const alert = await res.json();

          // ✅ Reinsert in correct table
          if (alert.status === "Unassigned") {
            addRow(unassignedEl, alert);
          } else if (alert.status === "Waitlist") {
            addRow(waitlistEl, alert);
          }
        } catch (err) {
          console.error("Failed to fetch updated alert:", err);
        }
      });
    };
    </script>


  </body>
</html>
